<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="./datasource-editor.html">

<dom-module id="admin-datasource">

    <style>
        #sort {
            height: 300px;
        }
    </style>

    <template>
        <iron-ajax
            auto 
            url={{url}}
            handle-as="json"
            last-response="{{datasources}}"
            on-response="_handleResponse"></iron-ajax>

        <paper-input id="filter" label="Filter by Data source name"></paper-input>
        <vaadin-grid id="sort" selection-mode="single"">
            <table>
                <colgroup>
                    <col name="name" sortable/>
                    <col name="filename" sortable/>
                    <col name="contactname" sortable/>
                    <col name="contactemail" sortable/>
                    <col name="created" sortable/>
                    <col name="modified" sortable/>
                    <col name="numOfFormulas" sortable/>
                </colgroup>
            </table>
        </vaadin-grid>
        <datasource-editor endpoint="{{endpoint}}"
            datasource="{{selectedDS}}"
            id="dialog" modal></datasource-editor>            
    </template>

    <script>
        Polymer({
            is: 'admin-datasource',

            properties: {
                endpoint: {
                    type: String,
                    value: "../../api",
                    notify: true,
                },
                url: {
                    type: String,
                    computed: '_computeUrl(endpoint)',
                },
                datasources: {
                    type: Array,
                    notify: true,
                }, 
                selectedDS: {
                    type: Object,
                    notify: true,
                }
            },

            _computeUrl: function(endpoint){
                return endpoint + "/datasource";
            },

            _handleResponse: function(){
                var grid = document.querySelector('#sort');
                var dialog = document.querySelector('#dialog');
                grid.items = this.datasources;

                grid.addEventListener('selected-items-changed', function(){
                        var idx = grid.selection.selected();
                        this.selectedDS = this.items[idx];
                        dialog.open();
                });
            },

            _popupDSEditor: function(ds){
                var dialog = document.querySelector('#dialog');
                this.selectedDS = ds;
                dialog.open();
            }
        });
    </script>
</dom-module>